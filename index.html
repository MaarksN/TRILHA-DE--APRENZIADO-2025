
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRANDE PR√äMIO ULTRA: EDI√á√ÉO NEON-CHROME (CORRIGIDO)</title>

    <!-- Import maps para Three.js e Firebase -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
        }
    }
    </script>
    
    <!-- Tone.js para √°udio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --aa-green-darker: #00ff9b;
            --aa-orange: #ff7b00;
            --cyber-pink: #ff00ff;
            --cyber-blue: #00ffff;
        }

        body {
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            background-color: #0d011a;
            color: var(--cyber-blue);
        }

        .text-shadow-glow {
            text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px var(--cyber-pink);
        }

        .pulse {
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 10px 0 var(--cyber-pink); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 10px var(--cyber-pink); }
            100% { transform: scale(1); box-shadow: 0 0 10px 0 var(--cyber-pink); }
        }

        #game-canvas-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .modal-bg {
            background-color: rgba(13, 1, 26, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .cyber-button {
             background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-blue));
             border: 2px solid var(--cyber-blue);
             box-shadow: 0 0 15px var(--cyber-pink);
             transition: all 0.3s ease;
        }
        .cyber-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--cyber-pink);
        }
         .cyber-button:disabled {
            background: #555;
            border-color: #777;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .modal-content {
            background: rgba(20, 2, 40, 0.9);
            border: 2px solid var(--cyber-blue);
            box-shadow: 0 0 20px var(--cyber-pink);
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto max-w-6xl">
        <h2 class="text-4xl md:text-5xl font-black text-center mb-2 uppercase text-shadow-glow">
            GRANDE PR√äMIO <span style="color:var(--aa-green-darker);">ULTRA</span>
        </h2>
        <p class="text-center text-gray-400 mb-6 font-bold">EDI√á√ÉO NEON-CHROME</p>

        <div id="game-wrapper" class="bg-black p-2 md:p-4 rounded-xl shadow-2xl border-2 border-pink-500 text-center flex flex-col items-center justify-center relative overflow-hidden">
            
            <div id="lobby-screen" class="w-full flex flex-col items-center">
                <h3 class="text-2xl font-bold mb-4 text-shadow-glow">ESCOLHA SEUS PILOTOS (AT√â 5)</h3>
                <div id="player-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-4xl mx-auto"></div>
                <div class="flex space-x-4 mt-8">
                     <button id="startGameBtn" class="cyber-button text-white font-bold py-3 px-8 rounded-lg text-xl uppercase tracking-wider" disabled>
                        Iniciar Corrida
                    </button>
                    <button id="leaderboardBtn" class="cyber-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl uppercase tracking-wider">
                        Recordes
                    </button>
                </div>
            </div>

            <div id="game-screen" class="hidden w-full h-[600px] relative">
                <div id="game-canvas-container" class="absolute inset-0 z-0 rounded-lg overflow-hidden"></div>
                <div id="game-ui-overlay" class="absolute top-0 left-0 w-full h-full p-2 md:p-4 flex flex-col justify-between z-10 pointer-events-none">
                    <div class="flex justify-between items-start text-white bg-black bg-opacity-60 px-4 py-2 rounded-lg">
                        <div>
                            <h3 class="text-lg md:text-2xl font-bold">FASE <span id="fase-atual">1</span></h3>
                            <p class="text-sm md:text-base">META: <span id="meta-pontos">0</span></p>
                            <p class="text-sm md:text-base">TEMPO: <span id="tempo-corrida">0.00</span>s</p>
                        </div>
                        <div class="text-right">
                             <h3 class="text-lg md:text-2xl font-bold">PONTUA√á√ÉO TOTAL</h3>
                             <p class="text-xl md:text-3xl font-black" style="color: var(--aa-green-darker);"><span id="pontuacao-total">0</span></p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end">
                         <button id="cameraToggleBtn" class="cyber-button text-white font-bold py-2 px-4 rounded-lg pointer-events-auto">C√ÇMERA</button>
                         <div id="speedometer" class="text-4xl font-black text-shadow-glow">0 KM/H</div>
                         <div class="w-24"></div> <!-- Espa√ßador -->
                    </div>
                    <div id="player-scores" class="flex justify-center gap-2 md:gap-4 w-full"></div>
                </div>
            </div>
            
            <div id="modal-container" class="hidden absolute inset-0 z-30 modal-bg items-center justify-center">
                <div id="leaderboard-modal" class="hidden flex-col modal-content p-8 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-3xl font-bold text-shadow-glow text-center mb-6">üèÜ Recordes üèÜ</h2>
                    <div id="leaderboard-list-container" class="max-h-80 overflow-y-auto">
                        <ol id="leaderboard-list" class="list-decimal list-inside space-y-2 text-lg"></ol>
                    </div>
                    <button id="closeLeaderboardBtn" class="mt-8 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Fechar</button>
                </div>

                <div id="quiz-modal" class="hidden flex-col modal-content p-8 rounded-lg shadow-xl w-full max-w-lg">
                    <h2 class="text-3xl font-bold mb-2 text-shadow-glow" id="quiz-title">QUIZ DA FASE!</h2>
                    <p class="text-lg mb-4" id="quiz-subtitle">Responda corretamente para avan√ßar!</p>
                    <div id="quiz-question-container">
                        <h3 class="text-2xl font-bold mb-4" id="quiz-question"></h3>
                        <div id="quiz-answers" class="space-y-3"></div>
                    </div>
                </div>

                 <div id="save-score-modal" class="hidden flex-col modal-content p-8 rounded-lg shadow-xl w-full max-w-md text-center">
                    <h2 class="text-3xl font-bold mb-2" id="game-over-title">Fim de Jogo!</h2>
                    <p class="text-lg mb-4">Sua pontua√ß√£o final foi: <span id="final-score" class="font-bold text-shadow-glow" style="color: var(--aa-orange);"></span></p>
                    <input type="text" id="playerNameInput" placeholder="Digite seu nome de piloto" class="text-black w-full p-2 rounded mb-4 bg-gray-300 focus:outline-none focus:ring-2 focus:ring-pink-500" maxlength="10">
                    <button id="submitScoreBtn" class="w-full cyber-button text-white font-bold py-2 px-4 rounded">Salvar Pontua√ß√£o</button>
                     <button id="playAgainFromSaveBtn" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Jogar Novamente</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    // --- M√ìDULOS ESSENCIAIS ---
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
    import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, collection, addDoc, query, getDocs, limit, serverTimestamp, orderBy } from 'firebase/firestore';

    // --- ELEMENTOS DO DOM ---
    const lobbyScreen = document.getElementById('lobby-screen');
    const gameScreen = document.getElementById('game-screen');
    const playerSelectionContainer = document.getElementById('player-selection');
    const startBtn = document.getElementById('startGameBtn');
    const leaderboardBtn = document.getElementById('leaderboardBtn');
    const canvasContainer = document.getElementById('game-canvas-container');
    const modalContainer = document.getElementById('modal-container');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
    const quizModal = document.getElementById('quiz-modal');
    const quizTitleEl = document.getElementById('quiz-title');
    const quizSubtitleEl = document.getElementById('quiz-subtitle');
    const quizQuestionContainerEl = document.getElementById('quiz-question-container');
    const quizQuestionEl = document.getElementById('quiz-question');
    const quizAnswersEl = document.getElementById('quiz-answers');
    const saveScoreModal = document.getElementById('save-score-modal');
    const gameOverTitleEl = document.getElementById('game-over-title');
    const finalScoreEl = document.getElementById('final-score');
    const playerNameInput = document.getElementById('playerNameInput');
    const submitScoreBtn = document.getElementById('submitScoreBtn');
    const playAgainFromSaveBtn = document.getElementById('playAgainFromSaveBtn');
    const tempoCorridaEl = document.getElementById('tempo-corrida');
    const pontuacaoTotalEl = document.getElementById('pontuacao-total');
    const faseAtualEl = document.getElementById('fase-atual');
    const metaPontosEl = document.getElementById('meta-pontos');
    const playerScoresContainer = document.getElementById('player-scores');
    const cameraToggleBtn = document.getElementById('cameraToggleBtn');
    const speedometerEl = document.getElementById('speedometer');
    
    // --- ESTADO DO JOGO E CONFIGURA√á√ïES ---
    let gameState = 'lobby';
    let faseAtual = 0, animationFrameId, jogadores = [];
    let obstaculos = [], coletaveis = [], powerups = [], aiCars = [], turbos = [], emps = [];
    const keys = {}, clock = new THREE.Clock();
    let db, auth;
    let phaseTimer = 0;
    let cameraMode = 0; 

    // --- SETUP 3D ---
    let scene, camera, renderer, composer, road, starField, rain;
    let bloomPass, filmPass, radialBlurPass;
    const gameArea = { width: 100, depth: 400 };

    // --- CONFIGURA√á√ïES DO JOGO ---
    const FASES = [
        { nivel: 1,  oP: 200, vI: 1.2, cO: 0.010, cC: 0.015, cP: 0.002, cIA: 0.008, cT: 0.003, cE: 0.001, cChuva: 0.1 },
        { nivel: 2,  oP: 300, vI: 1.4, cO: 0.012, cC: 0.012, cP: 0.003, cIA: 0.012, cT: 0.004, cE: 0.002, cChuva: 0.15 },
        { nivel: 3,  oP: 400, vI: 1.6, cO: 0.015, cC: 0.011, cP: 0.004, cIA: 0.015, cT: 0.005, cE: 0.002, cChuva: 0.2 },
        { nivel: 4,  oP: 500, vI: 1.8, cO: 0.018, cC: 0.010, cP: 0.005, cIA: 0.018, cT: 0.006, cE: 0.003, cChuva: 0.25 },
        { nivel: 5,  oP: 650, vI: 2.0, cO: 0.022, cC: 0.009, cP: 0.005, cIA: 0.022, cT: 0.007, cE: 0.003, cChuva: 0.3 },
        { nivel: 6,  oP: 800, vI: 2.2, cO: 0.025, cC: 0.008, cP: 0.006, cIA: 0.025, cT: 0.008, cE: 0.004, cChuva: 0.4 },
        { nivel: 7,  oP: 1000,vI: 2.4, cO: 0.028, cC: 0.007, cP: 0.006, cIA: 0.028, cT: 0.009, cE: 0.004, cChuva: 0.5 },
        { nivel: 8,  oP: 1250,vI: 2.6, cO: 0.031, cC: 0.006, cP: 0.007, cIA: 0.031, cT: 0.010, cE: 0.005, cChuva: 0.6 },
        { nivel: 9,  oP: 1500,vI: 2.8, cO: 0.035, cC: 0.005, cP: 0.007, cIA: 0.035, cT: 0.011, cE: 0.005, cChuva: 0.7 },
        { nivel: 10, oP: 2000,vI: 3.1, cO: 0.040, cC: 0.005, cP: 0.008, cIA: 0.040, cT: 0.012, cE: 0.006, cChuva: 0.8 }
    ];

    const JOGADORES_CONFIG = [
        { id: 1, cor: 0x00ff9b, keys: ['arrowleft', 'arrowright', 'arrowdown'] },
        { id: 2, cor: 0x00ffff, keys: ['a', 'd', 's'] },
        { id: 3, cor: 0xff7b00, keys: ['j', 'l', 'k'] },
        { id: 4, cor: 0xff00ff, keys: ['4', '6', '5'] },
        { id: 5, cor: 0x8A2BE2, keys: ['8', '9', '2'] }
    ];
    
    // --- INICIALIZA√á√ÉO GERAL ---
    function init() {
        initFirebase();
        setupLobby();
        init3D();
        setupEventListeners();
    }
    
    async function initFirebase() {
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        if (!firebaseConfigStr) {
            console.warn("Configura√ß√£o do Firebase n√£o encontrada.");
            leaderboardBtn.disabled = true;
            return;
        }
        try {
            const firebaseConfig = JSON.parse(firebaseConfigStr);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, async (user) => {
                if (!user) await signInAnonymously(auth);
            });
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            leaderboardBtn.disabled = true;
        }
    }

    const soundManager = {
        isInitialized: false, synth: null, kick: null, noise: null, bgMusic: null, rainSound: null, driftSound: null,
        init() {
            if (this.isInitialized) return;
            this.synth = new Tone.PolySynth(Tone.Synth).toDestination();
            this.kick = new Tone.MembraneSynth().toDestination();
            this.noise = new Tone.NoiseSynth().toDestination();
            const bass = new Tone.MonoSynth({ oscillator: { type: 'fmsquare' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.8 } }).toDestination();
            this.bgMusic = new Tone.Pattern((time, note) => { bass.triggerAttackRelease(note, '8n', time); }, ["C2", "C2", "F2", "F2", "G#1", "G#1", "G1", "G1"], "up");
            this.bgMusic.interval = "4n";
            this.rainSound = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 1, decay: 0.5, sustain: 1, release: 1 }, volume: -25 }).toDestination();
            this.driftSound = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.1, decay: 0.3, sustain: 1, release: 0.5 }, volume: -20 }).toDestination();
            this.isInitialized = true;
        },
        async startAudioContext() { if (Tone.context.state === 'suspended') await Tone.start(); },
        playCollect() { if(this.isInitialized) this.synth.triggerAttackRelease("C5", "16n"); },
        playShield() { if(this.isInitialized) this.synth.triggerAttackRelease(["C4", "E4", "G4"], "8n"); },
        playCrash() { if(this.isInitialized) this.kick.triggerAttackRelease("C1", "4n"); },
        playTurbo() { if(this.isInitialized) this.synth.triggerAttackRelease("G5", "8n"); },
        playQuizCorrect() { if(this.isInitialized) this.synth.triggerAttackRelease("E5", "8n"); },
        playQuizWrong() { if(this.isInitialized) this.synth.triggerAttackRelease("C3", "8n"); },
        playEMP() { if(this.isInitialized) new Tone.FMSynth().toDestination().triggerAttackRelease("C2", "1s"); },
        startDrift() { if(this.isInitialized && this.driftSound.state === 'stopped') this.driftSound.triggerAttack(); },
        stopDrift() { if(this.isInitialized) this.driftSound.triggerRelease(); },
        toggleMusic(state) {
            if (!this.isInitialized) this.init();
            this.startAudioContext();
            if (state) { this.bgMusic.start(0); Tone.Transport.start(); } else { Tone.Transport.stop(); this.bgMusic.stop(); }
        },
        toggleRainSound(state) {
            if (!this.isInitialized) this.init();
            if (state && this.rainSound.state === 'stopped') this.rainSound.triggerAttack();
            else this.rainSound.triggerRelease();
        },
        createEngineSound() {
            if(!this.isInitialized) this.init();
            const engine = new Tone.AMSynth({ volume: -25 }).toDestination();
            engine.triggerAttack("C1");
            return engine;
        },
        updateEngineSound(engine, speedRatio) { if (engine) engine.frequency.rampTo(40 + (speedRatio * 80), 0.1); },
        stopEngineSound(engine) { if (engine) engine.triggerRelease(); }
    };
    
    const quizManager = {
        questions: [
            { q: "O que √© 'repasse de ve√≠culos'?", a: ["Venda para consumidor final", "Venda de ve√≠culos entre lojas (B2B)", "Leil√£o p√∫blico"], c: 1 },
            { q: "Qual a vantagem da nossa plataforma para um lojista?", a: ["Garantia extendida", "Acesso r√°pido a novo estoque", "Financiamento ao consumidor"], c: 1 },
            { q: "Qual o foco da plataforma ARREMAQ?", a: ["Carros populares", "M√°quinas pesadas e agr√≠colas", "Barcos e Lanchas"], c: 1 },
            { q: "Como a alta da taxa SELIC impacta o neg√≥cio?", a: ["Positivo, carros ficam mais baratos", "Negativo, cr√©dito fica mais caro", "Nulo"], c: 1 },
            { q: "O que √© 'Cross-sell'?", a: ["Vender carros com problemas", "Oferecer servi√ßos adicionais", "Manobra de vendas ilegal"], c: 1 }
        ],
        activeQuiz: null, NUM_QUESTIONS_PER_QUIZ: 5, MIN_PASS_PERCENTAGE: 0.6,
        startPhaseQuiz() {
            gameState = 'quiz';
            soundManager.toggleMusic(false);
            const shuffled = [...this.questions].sort(() => 0.5 - Math.random());
            this.activeQuiz = { questions: shuffled.slice(0, this.NUM_QUESTIONS_PER_QUIZ), currentQIndex: 0, correctAnswers: 0, };
            modalContainer.style.display = 'flex';
            quizModal.style.display = 'flex';
            this.showNextQuestion();
        },
        showNextQuestion() {
            if (this.activeQuiz.currentQIndex < this.activeQuiz.questions.length) {
                const qData = this.activeQuiz.questions[this.activeQuiz.currentQIndex];
                quizTitleEl.textContent = `QUIZ - Pergunta ${this.activeQuiz.currentQIndex + 1} de ${this.NUM_QUESTIONS_PER_QUIZ}`;
                quizSubtitleEl.textContent = `Acerte ${this.MIN_PASS_PERCENTAGE * 100}% para avan√ßar`;
                quizQuestionEl.textContent = qData.q;
                quizAnswersEl.innerHTML = '';
                qData.a.forEach((answer, index) => {
                    const button = document.createElement('button');
                    button.textContent = answer;
                    button.className = 'w-full text-left p-3 bg-gray-700 hover:bg-blue-600 rounded transition-colors';
                    button.onclick = () => this.resolveAnswer(index);
                    quizAnswersEl.appendChild(button);
                });
                quizQuestionContainerEl.style.display = 'block';
            } else { this.endQuizSession(); }
        },
        resolveAnswer(selectedIndex) {
            const currentQuestion = this.activeQuiz.questions[this.activeQuiz.currentQIndex];
            if (selectedIndex === currentQuestion.c) { soundManager.playQuizCorrect(); this.activeQuiz.correctAnswers++; }
            else { soundManager.playQuizWrong(); }
            this.activeQuiz.currentQIndex++;
            this.showNextQuestion();
        },
        endQuizSession() {
            quizQuestionContainerEl.style.display = 'none';
            const score = this.activeQuiz.correctAnswers / this.activeQuiz.questions.length;
            if (score >= this.MIN_PASS_PERCENTAGE) {
                quizTitleEl.textContent = "QUIZ PASSOU!";
                quizSubtitleEl.textContent = `Voc√™ acertou ${this.activeQuiz.correctAnswers} de ${this.activeQuiz.questions.length}. Pr√≥xima fase em 3s...`;
                faseAtual++;
                setTimeout(() => {
                    quizModal.style.display = 'none';
                    modalContainer.style.display = 'none';
                    if (faseAtual >= FASES.length) {
                         showSaveScoreModal(jogadores.reduce((acc, p) => acc + p.pontos, 0), "Parab√©ns, voc√™ completou o jogo!");
                    } else { iniciarFase(); }
                }, 3000);
            } else {
                quizTitleEl.textContent = "QUIZ FALHOU!";
                quizSubtitleEl.textContent = `Voc√™ acertou apenas ${this.activeQuiz.correctAnswers}. A corrida termina aqui.`;
                setTimeout(() => {
                    quizModal.style.display = 'none';
                    showSaveScoreModal(jogadores.reduce((acc, p) => acc + p.pontos, 0), "Fim de jogo: n√£o atingiu a meta no quiz.");
                }, 3000);
            }
        }
    };

    function createPlayerCar(color) {
        const car = new THREE.Group();
        const bodyMat = new THREE.MeshStandardMaterial({ color, metalness: 0.9, roughness: 0.1, emissive: color, emissiveIntensity: 0.1 });
        if(scene) bodyMat.envMap = scene.background;
        const body = new THREE.Mesh(new THREE.BoxGeometry(8, 3, 16), bodyMat);
        body.position.y = 1.5;
        car.add(body);
        const cabinMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 1.0, roughness: 0.1 });
        const cabin = new THREE.Mesh(new THREE.BoxGeometry(6, 3, 8), cabinMat);
        cabin.position.set(0, 4.5, -2);
        car.add(cabin);
        car.castShadow = true;
        car.receiveShadow = true;
        return car;
    }

    class TrailRenderer {
        constructor(scene, color) { this.scene = scene; this.color = color; this.trailParts = []; this.maxParts = 50; }
        update(position) {
            let part = this.createPart();
            part.position.copy(position);
            part.position.y = -4.8;
            this.scene.add(part);
            this.trailParts.push(part);
            if (this.trailParts.length > this.maxParts) this.scene.remove(this.trailParts.shift());
            this.trailParts.forEach((p, i) => { const scale = (i / this.maxParts); p.scale.set(scale, scale, scale); p.material.opacity = scale; });
        }
        createPart() {
             const geometry = new THREE.PlaneGeometry(5, 5);
             const material = new THREE.MeshBasicMaterial({ color: this.color, transparent: true, opacity: 1.0, blending: THREE.AdditiveBlending });
             const plane = new THREE.Mesh(geometry, material);
             plane.rotation.x = -Math.PI / 2;
             return plane;
        }
        clear() { this.trailParts.forEach(p => this.scene.remove(p)); this.trailParts = []; }
    }
    
    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0d011a);
        scene.fog = new THREE.Fog(0x0d011a, gameArea.depth * 0.3, gameArea.depth * 0.8);
        camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 35, 70);
        camera.lookAt(0, 0, 0);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        canvasContainer.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(-40, 60, 30);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        createEnhancedEnvironment();

        const renderPass = new RenderPass(scene, camera);
        bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.6, 0.8);
        filmPass = new FilmPass(0.35, 0.025, 648, false);
        
        const RadialBlurShader = {
            uniforms: { 'tDiffuse': { value: null }, 'u_strength': { value: 0.0 } },
            vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform sampler2D tDiffuse; uniform float u_strength; varying vec2 vUv; void main() { vec2 center = vec2(0.5); vec4 color = vec4(0.0); vec2 toCenter = center - vUv; float offset = 0.001; for (float i = 0.0; i <= 10.0; i++) { float percent = i / 10.0; color += texture2D(tDiffuse, vUv + toCenter * percent * u_strength * offset); } gl_FragColor = color / 11.0;}`
        };
        radialBlurPass = new ShaderPass(RadialBlurShader);
        radialBlurPass.enabled = false;

        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloomPass);
        composer.addPass(radialBlurPass);
        composer.addPass(filmPass);
    }
    
    function createEnhancedEnvironment() {
        const roadTexture = new THREE.TextureLoader().load('https://placehold.co/64x64/111122/333344.png?text=');
        roadTexture.wrapS = THREE.RepeatWrapping; roadTexture.wrapT = THREE.RepeatWrapping; roadTexture.repeat.set(10, 20);
        road = new THREE.Mesh(new THREE.PlaneGeometry(gameArea.width, gameArea.depth * 2), new THREE.MeshStandardMaterial({ map: roadTexture, color: 0x222233, roughness: 0.8, metalness: 0.2 }));
        road.rotation.x = -Math.PI / 2; road.position.y = -5; road.receiveShadow = true;
        scene.add(road);

        const rainGeo = new THREE.BufferGeometry();
        const rainVertices = [];
        for(let i=0; i<15000; i++) { rainVertices.push( Math.random() * 200 - 100, Math.random() * 100, Math.random() * 400 - 200 ); }
        rainGeo.setAttribute('position', new THREE.Float32BufferAttribute(rainVertices, 3));
        const rainMaterial = new THREE.PointsMaterial({ color: 0xaaaaee, size: 0.3, transparent: true, opacity: 0.7 });
        rain = new THREE.Points(rainGeo, rainMaterial);
        rain.visible = false;
        scene.add(rain);
    }
    
    function createObstacleMesh() { return new THREE.Mesh(new THREE.ConeGeometry(8,12,4), new THREE.MeshStandardMaterial({color: 0xdc2626, roughness: 0.7})); }
    function createCollectibleMesh() { return new THREE.Mesh(new THREE.TorusGeometry(4, 1.5, 8, 32), new THREE.MeshStandardMaterial({color: 0x16a34a, emissive: 0x16a34a, emissiveIntensity: 0.8 })); }
    function createPowerupMesh() { return new THREE.Mesh(new THREE.SphereGeometry(4, 16, 16), new THREE.MeshStandardMaterial({color: 0x3b82f6, emissive: 0x3b82f6, transparent: true, opacity: 0.8})); }
    function createAICarMesh() {
        const car = new THREE.Mesh(new THREE.BoxGeometry(8, 4, 16), new THREE.MeshStandardMaterial({ color: [0x555555, 0x777777, 0x444444][Math.floor(Math.random() * 3)], roughness: 0.8 }));
        car.speed = Math.random() * 0.4 + 0.3; return car;
    }
    function createTurboMesh() { return new THREE.Mesh(new THREE.CylinderGeometry(2, 4, 8, 16), new THREE.MeshStandardMaterial({ color: 0xff7b00, emissive: 0xff7b00, emissiveIntensity: 1.5 })); }
    function createEmpMesh() {
        const geom = new THREE.IcosahedronGeometry(4, 1);
        const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x00ffff, emissiveIntensity: 2.0 });
        return new THREE.Mesh(geom, mat);
    }

    // CORRE√á√ÉO: Fun√ß√µes que estavam em falta adicionadas aqui
    async function showLeaderboard() {
        if (!db) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const q = query(collection(db, `artifacts/${appId}/public/data/leaderboard`), orderBy("score", "desc"), limit(10));
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<li>A carregar...</li>';
        modalContainer.style.display = 'flex';
        leaderboardModal.style.display = 'flex';
        try {
            const querySnapshot = await getDocs(q);
            list.innerHTML = '';
            if (querySnapshot.empty) {
                list.innerHTML = '<li>Nenhum recorde ainda. Seja o primeiro!</li>';
            } else {
                querySnapshot.forEach((doc, index) => {
                    const data = doc.data();
                    list.innerHTML += `<li>${index + 1}. ${data.name} - ${data.score} pontos</li>`;
                });
            }
        } catch (e) {
            list.innerHTML = '<li>N√£o foi poss√≠vel carregar os recordes.</li>';
            console.error(e);
        }
    }

    function showSaveScoreModal(score, title = "Fim de Jogo!") {
        gameState = 'fimDeJogo';
        soundManager.toggleMusic(false);
        soundManager.toggleRainSound(false);
        jogadores.forEach(p => soundManager.stopEngineSound(p.engineSound));
        finalScoreEl.textContent = score;
        gameOverTitleEl.textContent = title;
        modalContainer.style.display = 'flex';
        saveScoreModal.style.display = 'flex';
    }

    async function saveScore(playerName, score) {
        if (!db || !auth.currentUser) return;
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/public/data/leaderboard`), { name: playerName, score, timestamp: serverTimestamp() });
        } catch (e) { console.error("Erro ao salvar pontua√ß√£o: ", e); }
    }

    function setupEventListeners() {
        startBtn.addEventListener('click', iniciarJogo);
        leaderboardBtn.addEventListener('click', showLeaderboard);
        closeLeaderboardBtn.addEventListener('click', () => { modalContainer.style.display = 'none'; leaderboardModal.style.display = 'none'; });
        submitScoreBtn.addEventListener('click', async () => {
            const playerName = playerNameInput.value.trim();
            if (playerName) {
                await saveScore(playerName, jogadores.reduce((acc, p) => acc + p.pontos, 0));
                saveScoreModal.style.display = 'none'; showLeaderboard();
            }
        });
        playAgainFromSaveBtn.addEventListener('click', () => { modalContainer.style.display = 'none'; saveScoreModal.style.display = 'none'; voltarAoLobby(); });
        window.addEventListener('keydown', (e) => { keys[e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
        window.addEventListener('resize', () => {
            if (!renderer) return;
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            composer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        });
        cameraToggleBtn.addEventListener('click', toggleCamera);
    }

    function toggleCamera() { cameraMode = (cameraMode + 1) % 2; }
    
    function setupLobby() {
        playerSelectionContainer.innerHTML = '';
        JOGADORES_CONFIG.forEach(pConfig => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'flex items-center justify-between bg-gray-900 bg-opacity-50 border-2 border-pink-500 p-3 rounded-lg';
            const corHex = '#' + new THREE.Color(pConfig.cor).getHexString();
            playerDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="w-5 h-5 rounded-full mr-4" style="background-color: ${corHex}; box-shadow: 0 0 10px ${corHex};"></div>
                    <span class="font-bold text-lg">PILOTO ${pConfig.id}</span>
                </div>
                <div class="text-sm text-gray-400 font-mono">(${pConfig.keys.map(k => k.replace('arrow', '')).join('/')})</div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" value="" data-player-id="${pConfig.id}" class="sr-only peer player-toggle">
                  <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-pink-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                </label>
            `;
            playerSelectionContainer.appendChild(playerDiv);
        });

        playerSelectionContainer.querySelectorAll('.player-toggle').forEach(toggle => {
            toggle.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('.player-toggle:checked').length;
                startBtn.disabled = checkedCount === 0;
                startBtn.classList.toggle('pulse', checkedCount > 0);
            });
        });
    }

    function voltarAoLobby() {
        soundManager.toggleMusic(false);
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        gameState = 'lobby';
        gameScreen.classList.add('hidden');
        lobbyScreen.classList.remove('hidden');
        jogadores.forEach(p => { if(p.mesh) scene.remove(p.mesh); if(p.trail) p.trail.clear(); soundManager.stopEngineSound(p.engineSound); });
        [...obstaculos, ...coletaveis, ...powerups, ...aiCars, ...turbos, ...emps].forEach(obj => scene.remove(obj));
        jogadores = [], obstaculos = [], coletaveis = [], powerups = [], aiCars = [], turbos = [], emps = [];
        faseAtual = 0;
        setupLobby();
    }

    function iniciarJogo() {
        soundManager.startAudioContext();
        jogadores = Array.from(document.querySelectorAll('.player-toggle:checked')).map(toggle => {
            const pConfig = JOGADORES_CONFIG.find(p => p.id == toggle.dataset.playerId);
            return { ...pConfig, pontos: 0, ativo: true, hasShield: false, velocidade: 1.2, targetTilt: 0, keys: pConfig.keys.map(k => k.toLowerCase()), mesh: createPlayerCar(pConfig.cor), trail: new TrailRenderer(scene, new THREE.Color(pConfig.cor)), turboTimer: 0, isDrifting: false, isEmpd: false, empTimer: 0, engineSound: soundManager.createEngineSound() };
        });
        if (jogadores.length === 0) return;
        faseAtual = 0;
        lobbyScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        iniciarFase();
    }
    
    function iniciarFase() {
        gameState = 'jogando';
        soundManager.toggleMusic(true);
        phaseTimer = 0;
        const faseConfig = FASES[faseAtual];
        const isRaining = Math.random() < faseConfig.cChuva;
        rain.visible = isRaining;
        soundManager.toggleRainSound(isRaining);
        if(road && road.material) {
            road.material.roughness = isRaining ? 0.2 : 0.8;
            road.material.metalness = isRaining ? 0.5 : 0.2;
            road.material.needsUpdate = true;
        }

        [...obstaculos, ...coletaveis, ...powerups, ...aiCars, ...turbos, ...emps].forEach(obj => scene.remove(obj));
        obstaculos = [], coletaveis = [], powerups = [], aiCars = [], turbos = [], emps = [];
        jogadores.forEach((p, i) => {
            p.ativo = true; p.hasShield = false; p.turboTimer = 0; p.isDrifting = false; p.isEmpd = false;
            const initialX = (gameArea.width / (jogadores.length + 1)) * (i + 1) - (gameArea.width / 2);
            p.mesh.position.set(initialX, 0, 40); p.mesh.visible = true;
            if(!scene.getObjectById(p.mesh.id)) scene.add(p.mesh);
            p.trail.clear();
        });
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        animate();
    }
    
    function animate() {
        animationFrameId = requestAnimationFrame(animate);
        const delta = clock.getDelta();

        if (gameState === 'jogando') {
            phaseTimer += delta;
            atualizarJogo(delta);
        }

        fxManager.update(delta);

        if(rain.visible) {
            rain.geometry.attributes.position.array.forEach((val, i) => {
                if(i % 3 === 1) {
                    rain.geometry.attributes.position.array[i] -= 2.0 * delta * 60;
                    if(rain.geometry.attributes.position.array[i] < -20) rain.geometry.attributes.position.array[i] = 100;
                }
             });
             rain.geometry.attributes.position.needsUpdate = true;
        }
        updateCameraPosition();
        composer.render();
    }
    
    function updateCameraPosition() {
        if(jogadores.length === 0 || !jogadores[0] || !jogadores[0].mesh) return;
        const player = jogadores[0];
        let targetPosition = new THREE.Vector3();
        let lookAtTarget = player.mesh.position.clone().add(new THREE.Vector3(0, 3, -20));

        if(cameraMode === 0) {
            targetPosition.set(player.mesh.position.x, player.mesh.position.y + 25, player.mesh.position.z + 40);
        } else {
            targetPosition.set(player.mesh.position.x, player.mesh.position.y + 5, player.mesh.position.z + 1);
        }

        camera.position.lerp(targetPosition, 0.1);
        camera.lookAt(lookAtTarget);

        if (fxManager.shake > 0) {
             camera.position.x += (Math.random() - 0.5) * fxManager.shake;
             camera.position.y += (Math.random() - 0.5) * fxManager.shake;
             fxManager.shake *= 0.9;
        }
    }

    const fxManager = {
        shake: 0,
        empWave: null,
        triggerShake(intensity) { this.shake = intensity; },
        triggerEMP(position) {
            if(this.empWave) scene.remove(this.empWave);
            soundManager.playEMP();
            const geometry = new THREE.TorusGeometry(10, 1, 16, 100);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.8 });
            this.empWave = new THREE.Mesh(geometry, material);
            this.empWave.position.copy(position);
            this.empWave.rotation.x = Math.PI / 2;
            this.empWave.scale.set(0.1, 0.1, 0.1);
            scene.add(this.empWave);
        },
        update(delta) {
            if(this.empWave) {
                this.empWave.scale.x += delta * 20;
                this.empWave.scale.y += delta * 20;
                this.empWave.material.opacity -= delta * 0.8;
                if(this.empWave.material.opacity <= 0) scene.remove(this.empWave);
            }
        }
    };

    function spawnItem(itemArray, creationFunction, chance) {
        if (Math.random() < chance) {
            const newItem = creationFunction();
            const itemX = Math.random() * (gameArea.width - 20) - ((gameArea.width / 2) - 10);
            newItem.position.set(itemX, newItem.position.y || 0, -gameArea.depth / 2);
            itemArray.push(newItem);
            scene.add(newItem);
        }
    }
    
    function updateItems(items, faseConfig, playerBoxes, onCollect) {
        for (let i = items.length - 1; i >= 0; i--) {
            const item = items[i];
            item.position.z += faseConfig.vI * 60 * clock.getDelta() * (item.speed || 1);
            if (item.position.z > camera.position.z + 20) { scene.remove(item); items.splice(i, 1); continue; }
            const itemBox = new THREE.Box3().setFromObject(item);
            for (let j = 0; j < jogadores.length; j++) {
                if (jogadores[j].ativo && playerBoxes[j]?.intersectsBox(itemBox)) {
                    onCollect(jogadores[j], item, items, i);
                    break;
                }
            }
        }
    }

    function atualizarJogo(delta) {
        if (gameState !== 'jogando') return;
        const faseConfig = FASES[faseAtual];
        const x_boundary = gameArea.width / 2 - 5;
        
        jogadores.forEach(p => {
            if (p.empTimer > 0) { p.empTimer -= delta; if(p.empTimer <= 0) p.isEmpd = false; }
            if (!p.ativo || p.isEmpd) { soundManager.updateEngineSound(p.engineSound, 0); return; }
            if (keys[p.keys[2]]) { // Drift
                if(!p.isDrifting) { p.isDrifting = true; soundManager.startDrift(); }
                p.pontos += 0.1; p.velocidade = 0.8;
            } else {
                if(p.isDrifting) { p.isDrifting = false; soundManager.stopDrift(); }
                p.velocidade = p.turboTimer > 0 ? 2.0 : 1.2;
            }
            p.turboTimer = Math.max(0, p.turboTimer - delta);
            let move = 0;
            if (keys[p.keys[0]] && p.mesh.position.x > -x_boundary) move = -1;
            if (keys[p.keys[1]] && p.mesh.position.x < x_boundary) move = 1;
            const moveSpeed = p.isDrifting ? p.velocidade * 0.7 : p.velocidade;
            p.mesh.position.x += move * moveSpeed;
            p.targetTilt = p.isDrifting ? move * -0.5 : move * -0.25;
            p.mesh.rotation.z += (p.targetTilt - p.mesh.rotation.z) * 0.1;
            p.trail.update(p.mesh.position);
            soundManager.updateEngineSound(p.engineSound, (move !== 0 || p.turboTimer > 0) ? 1 : 0.5);
        });

        radialBlurPass.enabled = jogadores.some(p => p.turboTimer > 0);
        if (radialBlurPass.enabled) radialBlurPass.uniforms.u_strength.value = 0.03;
        
        spawnItem(obstaculos, createObstacleMesh, faseConfig.cO);
        spawnItem(coletaveis, createCollectibleMesh, faseConfig.cC);
        spawnItem(powerups, createPowerupMesh, faseConfig.cP);
        spawnItem(aiCars, createAICarMesh, faseConfig.cIA);
        spawnItem(turbos, createTurboMesh, faseConfig.cT);
        spawnItem(emps, createEmpMesh, faseConfig.cE);
        
        const playerBoxes = jogadores.map(p => p.ativo ? new THREE.Box3().setFromObject(p.mesh) : null);
        const handleCollision = (player, item, arr, index) => { fxManager.triggerShake(0.5); scene.remove(item); arr.splice(index, 1); };
        updateItems(obstaculos, faseConfig, playerBoxes, (p, obs, arr, i) => { soundManager.playCrash(); if(p.hasShield) p.hasShield=false; else { p.ativo=false; p.mesh.visible=false; soundManager.stopEngineSound(p.engineSound);} handleCollision(p, obs, arr, i); });
        updateItems(coletaveis, faseConfig, playerBoxes, (p, col, arr, i) => { soundManager.playCollect(); p.pontos += 10; handleCollision(p, col, arr, i); });
        updateItems(powerups, faseConfig, playerBoxes, (p, pow, arr, i) => { soundManager.playShield(); p.hasShield = true; handleCollision(p, pow, arr, i); });
        updateItems(aiCars, faseConfig, playerBoxes, (p, car, arr, i) => { soundManager.playCrash(); if(p.hasShield) p.hasShield=false; else { p.ativo=false; p.mesh.visible=false; soundManager.stopEngineSound(p.engineSound);} handleCollision(p, car, arr, i); });
        updateItems(turbos, faseConfig, playerBoxes, (p, tur, arr, i) => { soundManager.playTurbo(); p.turboTimer = 3; handleCollision(p, tur, arr, i); });
        updateItems(emps, faseConfig, playerBoxes, (p, empItem, arr, i) => {
            fxManager.triggerEMP(p.mesh.position);
            jogadores.forEach(otherPlayer => { if(otherPlayer !== p) { otherPlayer.isEmpd = true; otherPlayer.empTimer = 2; }});
            handleCollision(p, empItem, arr, i);
        });
        
        atualizarUI();
        
        const pontuacaoTotal = jogadores.reduce((acc, p) => acc + p.pontos, 0);
        if (pontuacaoTotal >= faseConfig.oP) { quizManager.startPhaseQuiz(); }
        if (jogadores.length > 0 && jogadores.every(p => !p.ativo)) { showSaveScoreModal(pontuacaoTotal, "Fim de jogo: pilotos eliminados!"); }
    }
    
    function atualizarUI() {
        const faseConfig = FASES[faseAtual];
        if (!faseConfig) return;
        const pontuacaoTotal = jogadores.reduce((acc, p) => acc + p.pontos, 0);
        faseAtualEl.textContent = faseConfig.nivel;
        metaPontosEl.textContent = faseConfig.oP;
        pontuacaoTotalEl.textContent = pontuacaoTotal;
        tempoCorridaEl.textContent = phaseTimer.toFixed(2);
        playerScoresContainer.innerHTML = '';
        jogadores.forEach(p => {
            const corHex = '#' + new THREE.Color(p.cor).getHexString();
            const scoreDiv = document.createElement('div');
            scoreDiv.className = `p-2 rounded-lg text-white text-center transition-all duration-300 flex-1 max-w-xs ${p.isEmpd ? 'animate-pulse bg-purple-800' : (p.ativo ? 'bg-black bg-opacity-50' : 'bg-red-800 bg-opacity-70')}`;
            scoreDiv.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <span class="font-bold" style="color: ${corHex};">P${p.id}</span>
                    <span class="font-black text-lg">${Math.floor(p.pontos)}</span>
                </div>
                <div class="h-5 mt-1 flex items-center justify-center text-xs font-bold gap-2">
                    ${p.hasShield ? `<span class="text-blue-300 bg-blue-800 bg-opacity-70 px-2 py-0.5 rounded">ESCUDO</span>` : ''}
                    ${p.turboTimer > 0 ? `<span class="text-orange-300 bg-orange-800 bg-opacity-70 px-2 py-0.5 rounded animate-pulse">TURBO</span>` : ''}
                    ${p.isDrifting ? `<span class="text-pink-300 bg-pink-800 bg-opacity-70 px-2 py-0.5 rounded">DRIFT</span>` : ''}
                </div>`;
            playerScoresContainer.appendChild(scoreDiv);
        });

        const player1 = jogadores.find(p => p.ativo);
        const speed = player1 ? (player1.velocidade * (player1.turboTimer > 0 ? 2 : 1) * 120) : 0;
        speedometerEl.textContent = `${Math.floor(speed)} KM/H`;
    }
    
    init();

</script>

</body>
</html>
